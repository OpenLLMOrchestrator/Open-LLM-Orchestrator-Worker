# Copyright 2026 Open LLM Orchestrator contributors. Licensed under the Apache License, Version 2.0; see LICENSE file.
# Publish plugin-contract to Maven (GitHub Packages) only on release to avoid 409 Conflict (immutable artifacts).
name: Publish plugin-contract to Maven

on:
  release:
    types: [published]

env:
  JAVA_VERSION: '21'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Determine version
        id: version
        run: |
          # Use release tag as version (strip leading 'v' if present)
          TAG="${GITHUB_REF#refs/tags/}"
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          echo "Publishing version: ${{ steps.version.outputs.version }}"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Publish plugin-contract to GitHub Packages
        env:
          MAVEN_REPO_URL: https://maven.pkg.github.com/${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./gradlew :plugin-contract:publish -Pversion=${{ steps.version.outputs.version }}
          echo "Published plugin-contract ${{ steps.version.outputs.version }} to GitHub Packages"

  # Optional: Publish to Maven Central (uncomment and set OSSRH + signing secrets if needed)
  # publish-maven-central:
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'release'
  #   needs: publish
  #   ...
